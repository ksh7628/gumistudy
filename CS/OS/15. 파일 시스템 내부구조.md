# 파일 시스템 내부구조

## 목차

[1. 파일 시스템 마운팅](#1-파일-시스템-마운팅)<br>
[2. 파티션](#2-파티션)<br>
[3. 파일 공유](#3-파일-공유)<br>
[4. 가상 파일 시스템](#4-가상-파일-시스템)<br>
[5. 원격 파일 시스템](#5-원격-파일-시스템)<br>
[6. 일관성](#6-일관성)<br>
[7. NFS](#7-nfs)<br>
[Reference](#reference)

<hr>

## 1. 파일 시스템 마운팅

마운트 : 디스크와 같은 물리적인 장치를 특정 위치 즉, 디렉토리에 연결시켜주는 것

파일이 사용되기 전에 열리는 것처럼 파일 시스템은 프로세스들에 의해 사용되기 전에 장착(mount) 되어야 한다.

마운트 과정

![](https://t1.daumcdn.net/cfile/tistory/263D04355196539304)

File System2 를 File System1 의 dev에 마운팅

![](https://t1.daumcdn.net/cfile/tistory/2244C834519654051B)

1. 운영체제에게 장치 이름과 파일 시스템을 부착 할 수 있는 파일 구조 내의 위치가 주어진다. 일반적으로 마운트 포인트는 장착되는 파일 시스템이 부착될 비어있는 디렉토리이다.
2. 운영체제는 장치가 유효한 파일 시스템을 포함하는지 확인 한다. 그 과정은 장치 드라이버가 장치 디렉토리를 읽고 디렉토리가 유효한 포맷을 가지고 있는지 확인하도록 요청 함으로써이루어 진다.
3. 운영체제는 파일 시스템이 지정된 마운트 포인트에 장착되었음을 디렉토리 구조에 기록한다. 이 기법은 운영체제가 디렉토리 구조를 순회하고 파일 시스템을 적절히 교체할 수 있게 한다.

<hr>

## 2. 파티션

파티션(Partition) : 하나의 물리적인 디스크를 여러개의 논리적 디스크로 나누는 것

윈도우 ex) 1번 디스크 -> C:\ , 2번 디스크 -> D:\

리눅스 ex) 1번 디스크 -> /dev/sda , 2번 디스크 -> /dev/sdb , 3번 디스크 -> /dev/sdc

장점

- 파티션은 트랙단위로 구성되기 때문에 같은 파티션에서 특정 데이터를 찾을 때 디스크의 헤더가 움직이는 거리가 짧아 엑세스속도가 빠름
- 논리적으로 공간이 분리되어있어 특정 파티션의 파일시스템 장애 시 다른 파티션은 안전함

단점

- 서버 운영 중 어떤 파티션은 공간이 부족하고 어떤 파티션은 남아도는 경우가 발생, 이 부분을 수정하기 위해 시스템의 정지시간이 필요함

일반적인 파티셔닝

| 종류    | 정의 및 역할                                                                                                                                                                                             |
| ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| swap    | 메모리 용량이 부족할 때 사용하는 디스크를 이용한 가상메모리로써 스왑을 사용할 경우 정상적인 성능을 발휘하지 못하므로 시스템에서 메모리를 모두 사용하여 스왑을 사용하게 될 경우 메모리 증설을 고려해야 함 |
| /boot   | 부팅에 필요한 커널, 모듈 등이 존재하는 디렉토리로써 무조건 적으로 파티션을 할당할 필요는 없지만 대부분의 리눅스에서는 별도의 파티셔닝 할 것을 권장                                                       |
| /backup | 별도의 디스크를 사용할 것을 권장                                                                                                                                                                         |
| /home   | 주로 사용자 데이터를 저장하기 위한 공간으로써 어떠한 용도로 사용하고 사용자들에게 홈 디렉토리 공간을 얼마만큼 제공할 것인가에 따라 파티션 용량이 달라짐                                                  |
| /var    | log나 사용자 데이터를 저장하는 목적으로 사용하는데 특별한 목적이 없는 한 따로 할당하지 않음                                                                                                              |
| /       | 따로 할당되지 않은 / 하위 디렉토리는 / 파티션 아래에 생성되는데 최소 5G 이상의 용량은 할당해야 함                                                                                                        |

<hr>

## 3. 파일 공유

파일 공유를 통해 여러 사용자들이 협업 시 일의 능률을 향상시킬 수 있다.

사용자가 파일을 공유할 수 있도록 하는 구조에서 시스템은 사용자가 다른 사용자의 파일에 접근할 수 있도록 허용할 수 있다.

시스템 간 ID가 다른 경우?

- 시스템 간 파일 공유를 통해 이동할 때 파일 소유권이 재설정됨

<hr>

## 4. 가상 파일 시스템

어떤 우분투 PC에 USB를 꼽고 그 안에 파일을 넣는 작업을 할 때 우리는 어떠한 불편함도 느끼지 않는다. 하지만 가만히 생각해보면 그 둘은 다른 파일시스템을 사용하고 있으며, 각 파일시스템은 파일 관리방법과 읽기, 쓰기의 방식이 모두 다르다. 그러나 우리는 이러한 일들을 아무런 어려움 없이 해낸다.

이러한 일을 가능하게 해주는 것이 **가상 파일시스템(VFS)** 이다.

VFS를 통한 파일시스템 공존

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcQuXqs%2FbtqA3fIYaYl%2FmFY0Io2NKcEfaucEMJ5KUK%2Fimg.png)

VFS의 정의는 **'파일시스템 관련 인터페이스를 사용자 공간 어플리케이션에 제공하는 커널 서브시스템'** 이다.

즉 open(), read(), write() 등의 시스템콜을 호출했을 때, 각 파일시스템이나 물리적 매체의 종류와 상관없이 동작하게 해주는 역할을 한다.

write()라는 시스템 콜이 발생했을 때, 실제 디바이스까지 전달 과정

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FHGQWl%2FbtqA2NsDHci%2FVDDzrqi0Bys2hdDg6yRiF0%2Fimg.png)

1. 사용자가 write() 시스템 콜을 호출한다.
2. VFS는 sys_write() 함수를 호출하여 실제 파일시스템의 쓰기 함수를 호출된다.
3. 실제 파일시스템의 쓰기 함수가 실행된다.
4. 물리적 장치에 쓰여진다.

위와 같은 순서로 VFS는 사용자가 write()라는 함수를 호출해도 자체적으로 파일시스템에 알맞는 함수를 호출하여 쓰기를 진행하기 때문에 **사용자는 연결된 파일시스템이 어떤 것이냐를 신경쓰지 않고도 읽고 쓰기를 자유롭게 할 수 있는 것**이다. 이러한 추상화 기능을 제공하는 계층을 **파일시스템 추상화 계층**이라고 한다.

**VFS의 주요 네 가지 객체**

| 종류                 | 정의 및 역할                                                                                                                                                                                                                                                                                  |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 슈퍼블록(SuperBlock) | 각 파일 시스템별로 구현하며, 본질적인 파일시스템 메타데이터, 매우 중요하기 때문에 복사본을 여러 곳에 저장해 놓기도 함                                                                                                                                                                         |
| 아이노드(Inode)      | 파일 각각의 메타데이터를 유지함, 파일의 주인(User, Group), 접근 권한, 파일 타입 등의 다양한 파일 정보를 유지, VFS에 마운트 되기 위해서는 반드시 메모리 상에 아이노드 객체를 구축해야 함                                                                                                       |
| 덴트리(Dentry)       | 디렉토리 엔트리(Diretory Entry)의 약자, 아이노드의 번호와 파일 이름과 관련하여 파일과 아이노드를 연결시켜 주는 역할, 캐시를 유지하여 자주 접근되는 경로를 더 빠르게 접근할 수 있도록 도와줌, 따라서 VFS는 경로명을 사용할 때마다 먼저 덴트리 캐시에서 찾고, 캐시에 없을 경우 직접 경로를 탐색 |
| 파일(File)           | 파일 객체의 file_operations 구조체는 파일 객체 관련 함수 포인터를 가지고 있다. read(), write(), seek(), open() 과 같은 함수로 구성                                                                                                                                                            |

**정리**

각각의 파일시스템을 모두 수용하기 위해서 VFS라는 추상화 계층을 만들게 되었다는 것이다. 그리고 내부적으로 슈퍼블록, 아이노드, 덴트리, 파일 객체를 통해 동작이 이뤄진다.

1. 모든 파일시스템은 그 정보를 유지하는 슈퍼블록을 하나씩 가진다.
2. 슈퍼블록은 그 안에 속한 파일들의 아이노드들의 포인터를 가지고 있다.
3. 아이노드는 각각의 파일에 대한 정보를 가지고 있다.
4. 파일의 경로는 모두 덴트리 객체로 메모리상에 저장된다.
5. 파일 객체는 프로세스가 사용중인 객체이다.

<hr>

## 5. 원격 파일 시스템

원격 파일 시스템을 사용하면 컴퓨터에서 하나 이상의 파일 시스템을 마운트할 수 있다.

하나 이상의 원격 시스템의 경우 파일이 포함된 시스템은 서버이고 파일에 접근하려는 시스템은 클라이언트이다.

네트워킹을 사용하여 시스템 간에 파일 시스템 엑세스 허용

1. FTP(File Transfer Protocol)와 같은 프로토콜을 통해서 기계간에 파일을 직접 전송
2. 로컬 기계에서 원격 디렉토리에 접근할 수 있는 분산 파일 시스템(Distributed File System, DFS)을 사용

<hr>

## 6. 일관성

예기치 못한 종료로 인한 파일 시스템 오류에 대비

간단한 방법으로는 데이터를 먼저 기록한 다음, 메타 데이터를 기록하는 방법이 있으며, 다른 방법으로는 파일 시스템 내의 모든 메타 데이터를 검색하여 문제가 있다고 판단되는 부분을 수정하는 방법이 있다.

**저널링(Journaling)** : DB에서 일관성 체크를 위해 사용하던 것을 파일 시스템에 적용한 것으로, 파일 시스템 내에서 업데이트(파일 쓰기, 메타 데이터 변경) 시에 그에 대한 로그를 작성하고 문제 발생시 로그를 참조하여 업데이트 취소가 가능하다. 일관성 체크를 위해 파일 시스템 전 영역을 체크 하지 않아도 된다.

<hr>

## 7. NFS

NFS(Network File System)은 썬 마이크로 시스템(SUN)에서 네트워크를 통해 파일을 공유할 수 있도록 만든 프로토콜이다. 다른 host에 있는 파일 시스템의 일부를 자신의 디렉토리인 것처럼 마운트하여 사용할 수 있다.

**장점**

- NFS를 사용하면 클라이언트 간에 데이터를 쉽게 공유할 수 있음
- 중앙 집중식 관리를 제공
- 데이터를 보호하기 위해 서버만 보호하여 보안을 제공

**사용**

- 윈도우 NFS 파일 서버를 비윈도우 운영 체제 환경에 배포하여 윈도우가 아닌 클라이언트 컴퓨터가 NFS 파일 공유에 액세스할 수 있도록 함
- SMB 및 NFS 프로토콜을 통해 액세스할 수 있는 파일 공유에 데이터를 저장하여 응용 프로그램을 운영 체제에서 다른 응용 프로그램으로 이동
- 윈도우 NFS 파일 서버를 사용하여 다중 플랫폼 클라이언트를 위한 SMB 및 NFS 프로토콜을 통해 동일한 파일 공유에 대한 다중 프로토콜 액세스를 제공

**작업 방법**

서버는 NFS 데몬을 구현하여 클라이언트가 다른 컴퓨터에 저장된 데이터에 액세스할 수 있는 데이터를 제공한다. 서버 관리자는 사용할 수 있는 클라이언트를 결정하고 인증된 클라이언트를 식별한다.

클라이언트 측에서 컴퓨터는 일반적으로 설치 명령을 실행하여 내보낸 데이터에 대한 액세스를 요청한다. 성공하면 클라이언트 컴퓨터가 파일 시스템을 보고 결정된 매개 변수 내에서 상호 작용할 수 있다.

<hr>

## Reference

- http://www.nastooh.com/teaching/Silberschatz_Operating_System_Concepts_10e_2018.pdf
- https://sojinhwan0207.tistory.com/6
- https://comyoung.tistory.com/109
- https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=jevida&logNo=140193161664
- https://hyoje420.tistory.com/53
- https://kr.bitwar.net/course/tips/3230.html
